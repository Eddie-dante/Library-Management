<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ngatho Secondary School Library</title>
  <style>
    /* Existing CSS remains unchanged */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      color: #333;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Flag_of_Kenya.svg/1280px-Flag_of_Kenya.svg.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center center;
      background-attachment: fixed;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 5px;
      color: white;
      z-index: 2000;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      role: alert;
    }
    .notification.error { background-color: #f44336; }
    .notification.success { background-color: #4CAF50; }
    #library-content {
      display: none;
      height: 100%;
      overflow-y: auto;
    }
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
    }
    #login-form-container {
      background-color: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    #login-form-container h2 {
      color: #004D40;
      margin-bottom: 25px;
    }
    #login-form-container input[type="password"] {
      width: calc(100% - 20px);
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1.1rem;
    }
    #login-form-container button {
      background-color: #004D40;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background-color 0.3s ease;
      margin: 5px;
    }
    #login-form-container button:hover {
      background-color: #26A69A;
    }
    #login-error-message {
      color: red;
      margin-top: 15px;
      font-weight: bold;
      display: none;
    }
    #wallpaper-upload-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    #wallpaper-upload-section label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #555;
    }
    #wallpaperInput {
      display: none;
    }
    #customWallpaperButton {
      background-color: #5cb85c;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 10px;
      transition: background-color 0.3s ease;
    }
    #customWallpaperButton:hover {
      background-color: #4cae4c;
    }
    #wallpaperFileName {
      display: inline-block;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
      font-size: 0.9rem;
      color: #777;
      width: calc(100% - 130px);
      vertical-align: middle;
      text-align: left;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    header {
      background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1521587765099-efb676f188ec?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') center center / cover no-repeat;
      color: white;
      text-align: center;
      padding: 20px;
    }
    #initial-buttons {
      text-align: center;
      margin-top: 50px;
      padding: 20px;
    }
    #initial-buttons button {
      padding: 15px 30px;
      font-size: 1.2rem;
      margin: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    #initial-buttons #librarianLoginBtn { background-color: #004D40; color: white; }
    #initial-buttons #librarianLoginBtn:hover { background-color: #26A69A; transform: translateY(-2px); }
    #initial-buttons #borrowBookBtn { background-color: #66BB6A; color: white; }
    #initial-buttons #borrowBookBtn:hover { background-color: #81C784; transform: translateY(-2px); }
    #initial-buttons #databaseBtn { background-color: #42A5F5; color: white; }
    #initial-buttons #databaseBtn:hover { background-color: #64B5F6; transform: translateY(-2px); }
    #navigation button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #004D40;
      color: white;
      transition: background-color 0.3s ease;
    }
    #navigation button:hover { background-color: #26A69A; }
    form {
      max-width: 600px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 20px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    input[type="number"] {
      width: calc(100% - 20px);
    }
    form button[type="submit"] {
      background-color: #004D40;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    form button[type="submit"]:hover {
      background-color: #26A69A;
    }
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      background-color: rgba(255, 255, 255, 0.9);
    }
    th, td {
      padding: 10px;
      border: 1px solid #e0e0e0;
      text-align: center;
    }
    th {
      background-color: #f5f5f5;
      cursor: pointer;
    }
    th.sort-asc::after { content: ' ↑'; }
    th.sort-desc::after { content: ' ↓'; }
    table button {
      width: auto;
      padding: 5px 10px;
      margin: 0;
      background-color: #004D40;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    table button:hover {
      background-color: #26A69A;
    }
    .overdue {
      background-color: #ffdddd;
      color: #CC0000;
      font-weight: bold;
    }
    .notes {
      font-size: 0.95rem;
      background-color: rgba(247, 247, 247, 0.9);
      padding: 15px;
      margin: 20px auto;
      border-left: 5px solid #004D40;
      max-width: 700px;
      color: #333;
      border-radius: 4px;
    }
    .notes strong {
      color: #004D40;
    }
    .hidden {
      display: none;
    }
    .librarian-section {
      max-width: 600px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 20px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      border-top: 5px solid #004D40;
    }
    .librarian-section h3 {
      color: #004D40;
      text-align: center;
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .librarian-section ul {
      list-style: none;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    .librarian-section ul li {
      padding: 8px 10px;
      border-bottom: 1px solid #f5f5f5;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
    }
    .librarian-section ul li:last-child {
      border-bottom: none;
    }
    .librarian-section input[type="text"],
    .librarian-section input[type="number"],
    .librarian-section select,
    .librarian-section button {
      margin-bottom: 5px;
    }
    .librarian-section button {
      background-color: #004D40;
      color: white;
    }
    .librarian-section button:hover {
      background-color: #26A69A;
    }
    #borrowedSearchInput, #learnerSearchInput {
      width: calc(95% - 22px);
      margin: 10px auto;
      display: block;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .low-stock {
      background-color: #ffe0b2;
      border-left: 5px solid #ff9800;
      font-weight: bold;
    }
    .out-of-stock {
      background-color: #ffcccc;
      border-left: 5px solid #cc0000;
      font-weight: bold;
      color: #cc0000;
    }
    #due-reminders-section {
      max-width: 700px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 20px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      border-top: 5px solid #E91E63;
    }
    #due-reminders-section h3 {
      color: #E91E63;
      text-align: center;
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    #due-reminders-section ul {
      list-style: none;
      padding: 0;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    #due-reminders-section ul li {
      padding: 8px 10px;
      border-bottom: 1px solid #f5f5f5;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
    }
    #due-reminders-section ul li:last-child {
      border-bottom: none;
    }
    #due-reminders-section .overdue-item {
      color: #CC0000;
      form: bold;
    }
    #due-reminders-section .due-soon-item {
      color: #FF5722;
    }
    #excel-import-section {
      max-width: 90%;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 20px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      border-top: 5px solid #FFC107;
    }
    #excel-import-section h3 {
      color: #FFC107;
      text-align: center;
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    #class-list-table-container {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #class-list-table {
      width: 100%;
      margin: 0;
      box-shadow: none;
    }
    #class-list-table thead th {
      position: sticky;
      top: 0;
      background-color: #f0f0f0;
      z-index: 1;
    }
    #class-list-table td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }
    #class-list-table td:nth-child(1) {
      font-weight: bold;
      min-width: 150px;
    }
    #class-list-table td:nth-child(2) {
      text-align: left;
      min-width: 250px;
    }
    .borrowed-book-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px dashed #eee;
    }
    .borrowed-book-item:last-child {
      border-bottom: none;
    }
    .borrowed-book-item button {
      padding: 3px 8px;
      font-size: 0.8em;
      margin-left: 10px;
      white-space: nowrap;
    }
    .no-books-borrowed {
      color: #777;
      font-style: italic;
    }
    #savedClassLists {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    #savedClassLists button {
      background-color: #4CAF50;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      flex-grow: 1;
      max-width: 180px;
    }
    #savedClassLists button:hover {
      background-color: #45a049;
    }
    #savedClassLists button.delete-btn {
      background-color: #f44336;
      margin-left: 5px;
      flex-grow: 0;
      width: auto;
    }
    #savedClassLists button.delete-btn:hover {
      background-color: #da190b;
    }
  </style>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div id="login-screen">
    <div id="login-form-container">
      <h2>Welcome to Ngatho Secondary School Library</h2>
      <p>Please enter the access password to continue.</p>
      <input type="password" id="accessPassword" placeholder="Enter password" autocomplete="off" aria-label="Enter access password" />
      <button id="loginButton">Login</button>
      <button id="enterLibraryButton" class="hidden">Enter Library</button>
      <p id="login-error-message" class="hidden">Incorrect password. Please try again.</p>
      <div id="wallpaper-upload-section">
        <label for="wallpaperInput">Change Wallpaper:</label>
        <input type="file" id="wallpaperInput" accept="image/*" aria-label="Upload wallpaper image">
        <button id="customWallpaperButton">Choose File</button>
        <span id="wallpaperFileName">No file chosen</span>
      </div>
    </div>
  </div>

  <div id="library-content">
    <header>
      <h1>📋 Ngatho Secondary School Library</h1>
      <h2>📋 Determined to succeed.</h2>
      <h2>Designed by Wegem(Edwin.G).</h2>
    </header>

    <div id="navigation" class="hidden">
      <button id="backBtn">Back to Main Menu</button>
      <button id="logoutBtn">Logout</button>
    </div>

    <div id="initial-buttons">
      <button id="librarianLoginBtn">Librarian Login</button>
      <button id="borrowBookBtn">Borrow a Book</button>
      <button id="databaseBtn">Database</button>
    </div>

    <div id="notes-section" class="hidden">
      <div class="notes">
        <strong>📚 Borrowing Instructions:</strong><br>
        • <strong>Only the librarian</strong> can mark a book as returned.<br>
        • The expected return date is <strong>required</strong> during borrowing.<br>
        • A <strong>library member</strong> may borrow <strong>up to 5 books</strong>.<br>
        • A <strong>non-member</strong> may only borrow <strong>3 books</strong>.<br>
        • Books not returned by the due date will be marked as <span style="color:red;">Overdue</span>.<br>
        • Books can only be borrowed if there is an <strong>available copy</strong>.
      </div>
    </div>

    <div id="due-reminders-section" class="hidden">
      <h3>⏰ Overdue & Due Soon Books</h3>
      <ul id="dueRemindersList"></ul>
    </div>

    <div id="librarian-tools-section" class="hidden">
      <div class="librarian-section">
        <h3>👥 Manage Library Members</h3>
        <label for="newMemberName">New Member Name:</label>
        <input type="text" id="newMemberName" placeholder="Enter member's name" required aria-label="Enter new member name">
        <button id="addMemberBtn">Add Member</button>
        <h4>Registered Members:</h4>
        <ul id="memberList"></ul>
      </div>

      <div class="librarian-section">
        <h3>📚 Manage Book Catalog</h3>
        <label for="newBookTitleInput">New Book Title:</label>
        <input type="text" id="newBookTitleInput" placeholder="Enter book title" required aria-label="Enter new book title">
        <label for="newBookTypeSelect">Book Type:</label>
        <select id="newBookTypeSelect" required aria-label="Book Type">
          <option value="">-- Book Type --</option>
          <option>Textbook</option>
          <option>Novel</option>
          <option>Reference</option>
          <option>Journal</option>
        </select>
        <label for="newBookQuantityInput">Quantity:</label>
        <input type="number" id="newBookQuantityInput" value="1" min="1" required aria-label="Enter book quantity">
        <button id="addBookToCatalogBtn">Add Book to Catalog</button>
        <h4>Available Books:</h4>
        <ul id="bookCatalogList"></ul>
      </div>

      <div id="excel-import-section" class="librarian-section">
        <h3>📊 Import & Manage Class List (Excel)</h3>
        <p>Upload an Excel file (<code>.xlsx</code> or <code>.xls</code>) with a column named "Name" (or "Learner Name") to view and manage their borrowed books. The first sheet will be used.</p>
        <input type="file" id="excelFileInput" accept=".xlsx, .xls" aria-label="Upload Excel class list">
        <button id="resetExcelInputBtn">Reset File</button>
        <div id="saveClassListDiv" class="hidden" style="margin-top:15px;">
          <input type="text" id="classListNameInput" placeholder="Name this class list (e.g., Form 1 East)" aria-label="Name class list">
          <button id="saveClassListBtn">Save Class List</button>
        </div>
        <h4>Saved Class Lists:</h4>
        <div id="savedClassLists"></div>
        <div id="class-list-table-container">
          <table id="class-list-table">
            <thead>
              <tr>
                <th>Learner Name</th>
                <th>Borrowed Books</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="class-list-table-body">
              <tr><td colspan="3">Upload an Excel file to see class list, or load a saved list.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="borrow-form-section" class="hidden">
      <form id="borrowForm">
        <label for="name">Learner's Name:</label>
        <input type="text" id="name" placeholder="Enter learner's name" required aria-label="Enter learner's name">
        <p id="borrowLimitInfo" style="font-size:0.9em; color:#666; text-align:right; margin-top:-5px;"></p>
        <label for="formLevel">Form Level:</label>
        <select id="formLevel" required aria-label="Select form level">
          <option value="">-- Select Form --</option>
          <option>Form 1</option>
          <option>Form 2</option>
          <option>Form 3</option>
          <option>Form 4</option>
        </select>
        <label for="stream">Stream:</label>
        <input type="text" id="stream" placeholder="Enter stream (e.g., East, West)" required aria-label="Enter stream">
        <label for="admAllover">ADM Allover:</label>
        <input type="text" id="admAllover" placeholder="Enter ADM Allover (e.g., 12345)" required aria-label="Enter ADM Allover">
        <label for="bookTitle">Book Title:</label>
        <select id="bookTitle" required aria-label="Select book title">
          <option value="">-- Select Book Title --</option>
        </select>
        <label for="bookType">Book Type (from catalog):</label>
        <input type="text" id="bookType" readonly placeholder="Select book title first" aria-label="Book type">
        <label for="borrowDate">Date Borrowed:</label>
        <input type="date" id="borrowDate" required aria-label="Select borrow date">
        <label for="returnDate">Expected Return Date:</label>
        <input type="date" id="returnDate" required aria-label="Select return date">
        <button type="submit">Register Borrow</button>
      </form>
    </div>

    <div id="borrowed-log-section" class="hidden">
      <h2 style="text-align:center;">📖 Borrowed Books Log</h2>
      <input type="text" id="borrowedSearchInput" placeholder="Search borrowed books (learner, book title, etc.)" aria-label="Search borrowed books">
      <button id="exportBorrowedBtn">Export to Excel</button>
      <table id="borrowedBooksTable">
        <thead>
          <tr>
            <th data-column="0">Learner</th>
            <th data-column="1">ADM Allover</th>
            <th data-column="2">Form</th>
            <th data-column="3">Stream</th>
            <th data-column="4">Book</th>
            <th data-column="5">Type</th>
            <th data-column="6">Date Borrowed</th>
            <th data-column="7">Return Date</th>
            <th data-column="8">Status</th>
            <th>Return (By Librarian)</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div id="learner-history-section" class="hidden">
      <h2 style="text-align:center;">📜 Learner Borrowing History</h2>
      <input type="text" id="learnerSearchInput" placeholder="Search learner by name or ADM" aria-label="Search learner history">
      <table id="learnerHistoryTable">
        <thead>
          <tr>
            <th>Learner</th>
            <th>ADM Allover</th>
            <th>Book</th>
            <th>Type</th>
            <th>Borrowed</th>
            <th>Expected Return</th>
            <th>Actual Return</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="learnerHistoryTableBody">
          <tr><td colspan="8">Search for a learner to view their history.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Constants
    const COLORS = {
      DEEP_TEAL: '#004D40',
      LIGHT_TEAL: '#26A69A',
      SOFT_GREEN: '#66BB6A'
    };

    // Element references
    const borrowForm = document.getElementById('borrowForm');
    const tableBody = document.getElementById('tableBody');
    const librarianLoginBtn = document.getElementById('librarianLoginBtn');
    const borrowBookBtn = document.getElementById('borrowBookBtn');
    const databaseBtn = document.getElementById('databaseBtn');
    const initialButtonsDiv = document.getElementById('initial-buttons');
    const navigationDiv = document.getElementById('navigation');
    const notesSection = document.getElementById('notes-section');
    const librarianToolsSection = document.getElementById('librarian-tools-section');
    const borrowFormSection = document.getElementById('borrow-form-section');
    const borrowedLogSection = document.getElementById('borrowed-log-section');
    const dueRemindersSection = document.getElementById('due-reminders-section');
    const dueRemindersList = document.getElementById('dueRemindersList');
    const learnerHistorySection = document.getElementById('learner-history-section');
    const learnerHistoryTableBody = document.getElementById('learnerHistoryTableBody');
    const newMemberNameInput = document.getElementById('newMemberName');
    const addMemberBtn = document.getElementById('addMemberBtn');
    const memberListUl = document.getElementById('memberList');
    const newBookTitleInput = document.getElementById('newBookTitleInput');
    const newBookTypeSelect = document.getElementById('newBookTypeSelect');
    const newBookQuantityInput = document.getElementById('newBookQuantityInput');
    const addBookToCatalogBtn = document.getElementById('addBookToCatalogBtn');
    const bookCatalogListUl = document.getElementById('bookCatalogList');
    const borrowBookTitleSelect = document.getElementById('bookTitle');
    const borrowBookTypeInput = document.getElementById('bookType');
    const nameInput = document.getElementById('name');
    const borrowLimitInfo = document.getElementById('borrowLimitInfo');
    const admAlloverInput = document.getElementById('admAllover');
    const formLevelSelect = document.getElementById('formLevel');
    const streamInput = document.getElementById('stream');
    const borrowDateInput = document.getElementById('borrowDate');
    const returnDateInput = document.getElementById('returnDate');
    const loginScreen = document.getElementById('login-screen');
    const accessPasswordInput = document.getElementById('accessPassword');
    const loginButton = document.getElementById('loginButton');
    const enterLibraryButton = document.getElementById('enterLibraryButton');
    const loginErrorMessage = document.getElementById('login-error-message');
    const libraryContent = document.getElementById('library-content');
    const wallpaperInput = document.getElementById('wallpaperInput');
    const customWallpaperButton = document.getElementById('customWallpaperButton');
    const wallpaperFileNameSpan = document.getElementById('wallpaperFileName');
    const borrowedSearchInput = document.getElementById('borrowedSearchInput');
    const learnerSearchInput = document.getElementById('learnerSearchInput');
    const excelFileInput = document.getElementById('excelFileInput');
    const resetExcelInputBtn = document.getElementById('resetExcelInputBtn');
    const saveClassListDiv = document.getElementById('saveClassListDiv');
    const classListNameInput = document.getElementById('classListNameInput');
    const saveClassListBtn = document.getElementById('saveClassListBtn');
    const savedClassListsContainer = document.getElementById('savedClassLists');
    const classListTableBody = document.getElementById('class-list-table-body');
    const exportBorrowedBtn = document.getElementById('exportBorrowedBtn');

    // Global variables
    let isLibrarianMode = false;
    let currentImportedLearners = [];
    let cachedMembers = [];
    let cachedBookCatalog = [];
    let cachedBorrowedBooks = [];

    // TODO: Replace with backend API call for secure password validation
    const MASTER_PASSWORD = 'edwin.g'; // Placeholder; move to server-side
    const LIBRARIAN_PASSWORD = 'eddie'; // Placeholder; move to server-side
    const BORROW_PASSWORD = 'giggy'; // Placeholder; move to server-side

    // Utility Functions
    function getData(key) {
      try {
        return JSON.parse(localStorage.getItem(key)) || [];
      } catch (e) {
        console.error(`Error reading ${key} from localStorage:`, e);
        showNotification('Failed to load data. Storage may be corrupted.', 'error');
        return [];
      }
    }

    function saveData(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
        updateCache();
      } catch (e) {
        console.error(`Error saving ${key} to localStorage:`, e);
        showNotification('Failed to save data. Storage may be full.', 'error');
      }
    }

    function updateCache() {
      cachedMembers = getData('members');
      cachedBookCatalog = getData('bookCatalog');
      cachedBorrowedBooks = getData('borrowedBooks');
    }

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    function showNotification(message, type = 'error') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notification.setAttribute('role', 'alert');
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function hideAllContentSections() {
      notesSection.classList.add('hidden');
      librarianToolsSection.classList.add('hidden');
      borrowFormSection.classList.add('hidden');
      borrowedLogSection.classList.add('hidden');
      dueRemindersSection.classList.add('hidden');
      learnerHistorySection.classList.add('hidden');
    }

    // Validate ADM Allover
    function isValidAdmAllover(admAllover) {
      // Example: Allow alphanumeric, 3-10 characters
      const regex = /^[a-zA-Z0-9]{3,10}$/;
      return regex.test(admAllover);
    }

    // Initial Data Setup
    function initializeData() {
      if (!localStorage.getItem('members')) {
        saveData('members', ['John Doe', 'Jane Smith', 'Alice Green']);
      }
      if (!localStorage.getItem('bookCatalog')) {
        saveData('bookCatalog', [
          { title: 'The River and the Source', type: 'Novel', quantity: 5, available: 5 },
          { title: 'Advanced Mathematics 1', type: 'Textbook', quantity: 3, available: 3 },
          { title: 'Chemistry Form 4', type: 'Textbook', quantity: 4, available: 4 },
          { title: 'Introduction to Python', type: 'Reference', quantity: 2, available: 2 },
          { title: 'Physics Form 3', type: 'Textbook', quantity: 1, available: 1 }
        ]);
      }
      if (!localStorage.getItem('savedClassLists')) {
        saveData('savedClassLists', {});
      }
      if (!localStorage.getItem('savedWallpaper')) {
        localStorage.setItem('savedWallpaper', '');
      }
      let needsMigration = false;
      const borrowList = getData('borrowedBooks');
      borrowList.forEach(entry => {
        if (!entry.status) {
          entry.status = 'Borrowed';
          needsMigration = true;
        }
        if (entry.status === 'Returned' && !entry.dateReturned) {
          entry.dateReturned = entry.returnDate;
          needsMigration = true;
        }
        if (!entry.id) {
          entry.id = Date.now().toString() + Math.random().toString(36).substring(2, 8);
          needsMigration = true;
        }
        if (!entry.admAllover) {
          entry.admAllover = 'N/A';
          needsMigration = true;
        }
      });
      if (needsMigration) {
        saveData('borrowedBooks', borrowList);
      }
      updateCache();
    }

    // Member Management
    function loadMembers() {
      memberListUl.innerHTML = '';
      if (cachedMembers.length === 0) {
        memberListUl.innerHTML = '<li>No members registered yet.</li>';
      } else {
        cachedMembers.forEach(member => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span>${sanitizeInput(member)}</span>
            <button onclick="deleteMember('${member}')">Delete</button>
          `;
          memberListUl.appendChild(li);
        });
      }
    }

    function addMember() {
      const newMemberName = sanitizeInput(newMemberNameInput.value.trim());
      if (!newMemberName) {
        showNotification('Please enter a valid member name.', 'error');
        return;
      }
      if (cachedMembers.map(m => m.toLowerCase()).includes(newMemberName.toLowerCase())) {
        showNotification('This member is already registered.', 'error');
        return;
      }
      cachedMembers.push(newMemberName);
      saveData('members', cachedMembers);
      newMemberNameInput.value = '';
      loadMembers();
      showNotification(`Member "${newMemberName}" added successfully.`, 'success');
    }

    function deleteMember(memberName) {
      if (!isLibrarianMode) {
        showNotification('Access Denied: Only the librarian can delete members.', 'error');
        return;
      }
      if (confirm(`Are you sure you want to delete member "${memberName}"?`)) {
        cachedMembers = cachedMembers.filter(m => m !== memberName);
        saveData('members', cachedMembers);
        loadMembers();
        showNotification(`Member "${memberName}" deleted successfully.`, 'success');
      }
    }

    // Book Catalog Management
    function loadBookCatalog() {
      bookCatalogListUl.innerHTML = '';
      borrowBookTitleSelect.innerHTML = '<option value="">-- Select Book Title --</option>';
      // Preserve static book types from HTML and add unique types from catalog
      const staticBookTypes = ['Textbook', 'Novel', 'Reference', 'Journal'];
      const catalogBookTypes = [...new Set(cachedBookCatalog.map(book => book.type))];
      const allBookTypes = [...new Set([...staticBookTypes, ...catalogBookTypes])].sort();
      
      // Clear existing options but keep the placeholder
      newBookTypeSelect.innerHTML = '<option value="">-- Book Type --</option>';
      // Populate dropdown with all unique book types
      allBookTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        newBookTypeSelect.appendChild(option);
      });

      if (cachedBookCatalog.length === 0) {
        bookCatalogListUl.innerHTML = '<li>No books in catalog yet.</li>';
      } else {
        cachedBookCatalog.sort((a, b) => a.title.localeCompare(b.title)).forEach(book => {
          const li = document.createElement('li');
          if (book.available <= 2 && book.available > 0) {
            li.classList.add('low-stock');
          } else if (book.available === 0) {
            li.classList.add('out-of-stock');
          }
          li.innerHTML = `
            <span>${sanitizeInput(book.title)} (${book.type}) - Available: ${book.available}/${book.quantity}</span>
            <button onclick="deleteBook('${book.title}')">Delete</button>
          `;
          bookCatalogListUl.appendChild(li);
          if (book.available > 0) {
            const option = document.createElement('option');
            option.value = book.title;
            option.textContent = `${book.title} (Available: ${book.available})`;
            borrowBookTitleSelect.appendChild(option);
          }
        });
      }
    }

    function addBookToCatalog() {
      const newTitle = sanitizeInput(newBookTitleInput.value.trim());
      const newType = newBookTypeSelect.value;
      const newQuantity = parseInt(newBookQuantityInput.value, 10);
      if (!newTitle || !newType || isNaN(newQuantity) || newQuantity <= 0) {
        showNotification('Please enter a valid book title, type, and quantity.', 'error');
        return;
      }
      const existingBookIndex = cachedBookCatalog.findIndex(book => book.title.toLowerCase() === newTitle.toLowerCase());
      if (existingBookIndex > -1) {
        cachedBookCatalog[existingBookIndex].quantity += newQuantity;
        cachedBookCatalog[existingBookIndex].available += newQuantity;
        showNotification(`Updated quantity for "${newTitle}". New total: ${cachedBookCatalog[existingBookIndex].quantity}`, 'success');
      } else {
        cachedBookCatalog.push({ title: newTitle, type: newType, quantity: newQuantity, available: newQuantity });
        showNotification(`Added "${newTitle}" with ${newQuantity} copies to catalog.`, 'success');
      }
      saveData('bookCatalog', cachedBookCatalog);
      newBookTitleInput.value = '';
      newBookTypeSelect.value = '';
      newBookQuantityInput.value = '1';
      loadBookCatalog();
    }

    function deleteBook(bookTitle) {
      if (!isLibrarianMode) {
        showNotification('Access Denied: Only the librarian can delete books.', 'error');
        return;
      }
      if (confirm(`Are you sure you want to delete book "${bookTitle}" from the catalog?`)) {
        cachedBookCatalog = cachedBookCatalog.filter(book => book.title !== bookTitle);
        saveData('bookCatalog', cachedBookCatalog);
        loadBookCatalog();
        showNotification(`Book "${bookTitle}" deleted from catalog.`, 'success');
      }
    }

    // Borrow Form Functions
    function updateBorrowBookType() {
      const selectedTitle = borrowBookTitleSelect.value;
      const selectedBook = cachedBookCatalog.find(book => book.title === selectedTitle);
      borrowBookTypeInput.value = selectedBook ? selectedBook.type : '';
    }

    function updateBorrowLimitInfo() {
      const learnerName = sanitizeInput(nameInput.value.trim());
      if (learnerName) {
        const isMember = cachedMembers.map(m => m.toLowerCase()).includes(learnerName.toLowerCase());
        const currentBorrowCount = cachedBorrowedBooks.filter(
          entry => entry.name.toLowerCase() === learnerName.toLowerCase() && entry.status === 'Borrowed'
        ).length;
        const limit = isMember ? 5 : 3;
        borrowLimitInfo.textContent = `Current books: ${currentBorrowCount} / Limit: ${limit}`;
      } else {
        borrowLimitInfo.textContent = '';
      }
    }

    function borrowBook(e) {
      e.preventDefault();
      const name = sanitizeInput(nameInput.value.trim());
      const formLevel = formLevelSelect.value;
      const stream = sanitizeInput(streamInput.value.trim());
      const admAllover = sanitizeInput(admAlloverInput.value.trim());
      const bookTitle = borrowBookTitleSelect.value;
      const type = borrowBookTypeInput.value;
      const borrowDate = borrowDateInput.value;
      const returnDate = returnDateInput.value;

      if (!name || !formLevel || !stream || !admAllover || !bookTitle || !type || !borrowDate || !returnDate) {
        showNotification('Please fill in all required borrowing details.', 'error');
        return;
      }

      if (!isValidAdmAllover(admAllover)) {
        showNotification('ADM Allover must be 3-10 alphanumeric characters.', 'error');
        return;
      }

      const existingAdm = cachedBorrowedBooks.find(entry => entry.admAllover === admAllover && entry.status === 'Borrowed');
      if (existingAdm && existingAdm.name.toLowerCase() !== name.toLowerCase()) {
        showNotification(`ADM Allover "${admAllover}" is already associated with another learner.`, 'error');
        return;
      }

      const today = new Date().toISOString().split('T')[0];
      if (!borrowDate || new Date(borrowDate) > new Date(today)) {
        showNotification('Borrow date must be today or in the past.', 'error');
        return;
      }
      if (!returnDate || new Date(returnDate) < new Date(borrowDate)) {
        showNotification('Return date cannot be before borrow date.', 'error');
        return;
      }
      if (new Date(returnDate).setHours(0,0,0,0) < new Date(today).setHours(0,0,0,0)) {
        showNotification('Return date cannot be in the past.', 'error');
        return;
      }

      const selectedBook = cachedBookCatalog.find(book => book.title === bookTitle);
      if (!selectedBook || selectedBook.available <= 0) {
        showNotification(`"${bookTitle}" is currently out of stock.`, 'error');
        return;
      }

      const isMember = cachedMembers.map(m => m.toLowerCase()).includes(name.toLowerCase());
      const currentBorrowCount = cachedBorrowedBooks.filter(
        entry => entry.name.toLowerCase() === name.toLowerCase() && entry.status === 'Borrowed'
      ).length;
      const limit = isMember ? 5 : 3;
      if (currentBorrowCount >= limit) {
        showNotification(`${name} has reached their borrowing limit (${limit} books).`, 'error');
        return;
      }

      selectedBook.available--;
      saveData('bookCatalog', cachedBookCatalog);
      cachedBorrowedBooks.push({
        id: Date.now().toString() + Math.random().toString(36).substring(2, 8),
        name,
        admAllover,
        form: formLevel,
        stream,
        book: bookTitle,
        type,
        borrowDate,
        returnDate,
        status: 'Borrowed',
        dateReturned: null
      });
      saveData('borrowedBooks', cachedBorrowedBooks);
      borrowForm.reset();
      borrowBookTypeInput.value = '';
      borrowLimitInfo.textContent = '';
      loadBorrowed();
      loadBookCatalog();
      loadDueReminders();
      loadClassListWithBorrowedBooks(currentImportedLearners);
      showNotification(`"${bookTitle}" successfully borrowed by ${name}!`, 'success');
    }

    // Borrowed Books Table
    function loadBorrowed() {
      tableBody.innerHTML = '';
      const activeBorrows = cachedBorrowedBooks.filter(entry => entry.status === 'Borrowed'); // Only show borrowed books
      const today = new Date().toISOString().split('T')[0];

      if (activeBorrows.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="10">No books currently borrowed.</td></tr>`;
        return;
      }

      activeBorrows.forEach(entry => {
        const isOverdue = today > entry.returnDate;
        const tr = document.createElement('tr');
        tr.dataset.search = `${entry.name} ${entry.admAllover} ${entry.book} ${entry.type} ${entry.form} ${entry.stream}`.toLowerCase();
        const returnButtonHtml = isLibrarianMode ? `<button onclick="returnBook('${entry.id}')">Returned</button>` : '';
        tr.innerHTML = `
          <td>${sanitizeInput(entry.name)}</td>
          <td>${sanitizeInput(entry.admAllover || 'N/A')}</td>
          <td>${sanitizeInput(entry.form)}</td>
          <td>${sanitizeInput(entry.stream)}</td>
          <td>${sanitizeInput(entry.book)}</td>
          <td>${sanitizeInput(entry.type)}</td>
          <td>${entry.borrowDate}</td>
          <td>${entry.returnDate}</td>
          <td class="${isOverdue ? 'overdue' : ''}">${isOverdue ? '⏰ Overdue' : '✅ Borrowed'}</td>
          <td>${returnButtonHtml}</td>
        `;
        tableBody.appendChild(tr);
      });
      filterBorrowedBooks();
    }

    function returnBook(borrowId) {
      if (!isLibrarianMode) {
        showNotification('Access Denied: Only the librarian can mark books as returned.', 'error');
        return;
      }
      const entryToReturn = cachedBorrowedBooks.find(entry => entry.id === borrowId);
      if (!entryToReturn || entryToReturn.status === 'Returned') {
        showNotification('This book has already been returned or record not found.', 'error');
        return;
      }
      if (confirm(`Are you sure the book "${entryToReturn.book}" borrowed by "${entryToReturn.name}" (ADM: ${entryToReturn.admAllover || 'N/A'}) has been returned?`)) {
        const bookInCatalog = cachedBookCatalog.find(book => book.title === entryToReturn.book);
        if (bookInCatalog) {
          bookInCatalog.available++;
          saveData('bookCatalog', cachedBookCatalog);
        } else {
          console.warn(`Returned book "${entryToReturn.book}" not found in catalog.`);
        }
        // Remove the book entry from cachedBorrowedBooks instead of marking it as Returned
        cachedBorrowedBooks = cachedBorrowedBooks.filter(entry => entry.id !== borrowId);
        saveData('borrowedBooks', cachedBorrowedBooks);
        loadBorrowed(); // Refresh borrowed books table to reflect removal
        loadBookCatalog();
        loadDueReminders();
        loadClassListWithBorrowedBooks(currentImportedLearners);
        // Do not update learner history since the record is removed
        showNotification(`"${entryToReturn.book}" returned by ${entryToReturn.name} and removed from borrowed books.`, 'success');
      }
    }

    function filterBorrowedBooks() {
      const searchTerm = borrowedSearchInput.value.toLowerCase();
      const rows = tableBody.getElementsByTagName('tr');
      for (let row of rows) {
        if (row.cells.length <= 1) {
          row.style.display = '';
          continue;
        }
        const rowText = row.dataset.search || row.textContent.toLowerCase();
        row.style.display = rowText.includes(searchTerm) ? '' : 'none';
      }
    }

    // Learner History
    function loadLearnerHistory() {
      const searchTerm = sanitizeInput(learnerSearchInput.value.toLowerCase().trim());
      learnerHistoryTableBody.innerHTML = '';
      if (!searchTerm) {
        learnerHistoryTableBody.innerHTML = `<tr><td colspan="8">Search for a learner to view their history.</td></tr>`;
        return;
      }
      const filteredHistory = cachedBorrowedBooks
        .filter(entry => entry.name.toLowerCase().includes(searchTerm) || (entry.admAllover && entry.admAllover.toLowerCase().includes(searchTerm)))
        .sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate)); // Sort by borrow date descending
      if (filteredHistory.length === 0) {
        learnerHistoryTableBody.innerHTML = `<tr><td colspan="8">No history found for "${searchTerm}".</td></tr>`;
        return;
      }
      filteredHistory.forEach(entry => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${sanitizeInput(entry.name)}</td>
          <td>${sanitizeInput(entry.admAllover || 'N/A')}</td>
          <td>${sanitizeInput(entry.book)}</td>
          <td>${sanitizeInput(entry.type)}</td>
          <td>${entry.borrowDate}</td>
          <td>${entry.returnDate}</td>
          <td>${entry.status === 'Returned' ? (entry.dateReturned || 'N/A') : 'Still Borrowed'}</td>
          <td class="${entry.status === 'Returned' ? 'returned' : entry.status === 'Overdue' ? 'overdue' : ''}">${entry.status}</td>
        `;
        learnerHistoryTableBody.appendChild(tr);
      });
    }

    // Due Reminders
    function loadDueReminders() {
      dueRemindersList.innerHTML = '';
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const threeDaysLater = new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      const relevantBooks = cachedBorrowedBooks
        .filter(entry => {
          if (entry.status === 'Returned') return false;
          const returnDate = entry.returnDate;
          return returnDate <= threeDaysLater;
        })
        .sort((a, b) => new Date(a.returnDate) - new Date(b.returnDate));
      if (relevantBooks.length === 0) {
        dueRemindersList.innerHTML = '<li>No books overdue or due in the next 3 days.</li>';
        return;
      }
      relevantBooks.forEach(entry => {
        const li = document.createElement('li');
        const returnDate = new Date(entry.returnDate);
        let statusText = '';
        let statusClass = '';
        if (entry.returnDate < todayStr) {
          const diffDays = Math.ceil((today - returnDate) / (1000 * 60 * 60 * 24));
          statusText = `OVERDUE by ${diffDays} day${diffDays > 1 ? 's' : ''}!`;
          statusClass = 'overdue-item';
        } else if (entry.returnDate === todayStr) {
          statusText = `DUE TODAY!`;
          statusClass = 'due-soon-item';
        } else {
          const diffDays = Math.ceil((returnDate - today) / (1000 * 60 * 60 * 24));
          statusText = `Due in ${diffDays} day${diffDays > 1 ? 's' : ''}`;
          statusClass = 'due-soon-item';
        }
        li.innerHTML = `
          <span><strong>${sanitizeInput(entry.book)}</strong> by ${sanitizeInput(entry.name)} (ADM: ${sanitizeInput(entry.admAllover || 'N/A')}, Form ${entry.form} ${sanitizeInput(entry.stream)}) - Due: ${entry.returnDate}</span>
          <span class="${statusClass}">${statusText}</span>
        `;
        dueRemindersList.appendChild(li);
      });
    }

    // Excel Import and Class List Management
    function importExcelFile(file) {
      if (!file) {
        saveClassListDiv.classList.add('hidden');
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonSheet = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          if (jsonSheet.length === 0) {
            showNotification('The Excel file is empty or could not be parsed.', 'error');
            classListTableBody.innerHTML = `<tr><td colspan="3">The Excel file is empty or could not be parsed.</td></tr>`;
            saveClassListDiv.classList.add('hidden');
            currentImportedLearners = [];
            return;
          }
          const headerRow = jsonSheet[0];
          const possibleNameHeaders = ['name', 'learner name', 'student name', 'fullname', 'student'];
          const nameColumnIndex = headerRow.findIndex(header => possibleNameHeaders.includes(String(header).toLowerCase().trim()));
          if (nameColumnIndex === -1) {
            showNotification('No "Name" or "Learner Name" column found in Excel file.', 'error');
            classListTableBody.innerHTML = `<tr><td colspan="3">Could not find "Name" column in Excel.</td></tr>`;
            saveClassListDiv.classList.add('hidden');
            currentImportedLearners = [];
            return;
          }
          currentImportedLearners = jsonSheet.slice(1)
            .map(row => String(row[nameColumnIndex]).trim())
            .filter(name => name);
          if (currentImportedLearners.length === 0) {
            showNotification('No learner names found in the Excel file.', 'error');
            classListTableBody.innerHTML = `<tr><td colspan="3">No learner names found in the Excel file.</td></tr>`;
            saveClassListDiv.classList.add('hidden');
            return;
          }
          showNotification(`Successfully imported ${currentImportedLearners.length} learners from "${file.name}".`, 'success');
          loadClassListWithBorrowedBooks(currentImportedLearners);
          saveClassListDiv.classList.remove('hidden');
          classListNameInput.value = '';
        } catch (e) {
          showNotification('Error parsing Excel file. Please ensure it is a valid .xlsx or .xls file.', 'error');
          console.error('Excel parsing error:', e);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function saveClassList() {
      const listName = sanitizeInput(classListNameInput.value.trim());
      if (!listName) {
        showNotification('Please enter a name for this class list.', 'error');
        return;
      }
      if (currentImportedLearners.length === 0) {
        showNotification('No class list imported to save.', 'error');
        return;
      }
      const savedClassLists = getData('savedClassLists');
      if (savedClassLists[listName] && !confirm(`A class list named "${listName}" already exists. Do you want to overwrite it?`)) {
        return;
      }
      savedClassLists[listName] = currentImportedLearners;
      saveData('savedClassLists', savedClassLists);
      showNotification(`Class list "${listName}" saved successfully!`, 'success');
      classListNameInput.value = '';
      saveClassListDiv.classList.add('hidden');
      excelFileInput.value = '';
      loadSavedClassListButtons();
    }

    function loadSavedClassListButtons() {
      savedClassListsContainer.innerHTML = '';
      const savedLists = getData('savedClassLists');
      const listNames = Object.keys(savedLists).sort();
      if (listNames.length === 0) {
        savedClassListsContainer.innerHTML = 'No saved class lists.';
        return;
      }
      listNames.forEach(name => {
        const buttonWrapper = document.createElement('div');
        buttonWrapper.style.display = 'flex';
        buttonWrapper.style.alignItems = 'center';
        buttonWrapper.style.marginBottom = '5px';
        const loadBtn = document.createElement('button');
        loadBtn.textContent = name;
        loadBtn.onclick = () => {
          currentImportedLearners = savedLists[name];
          loadClassListWithBorrowedBooks(currentImportedLearners);
        };
        buttonWrapper.appendChild(loadBtn);
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'X';
        deleteBtn.classList.add('delete-btn');
        deleteBtn.title = `Delete ${name}`;
        deleteBtn.onclick = e => {
          e.stopPropagation();
          deleteClassList(name);
        };
        buttonWrapper.appendChild(deleteBtn);
        savedClassListsContainer.appendChild(buttonWrapper);
      });
    }

    function deleteClassList(listName) {
      if (!isLibrarianMode) {
        showNotification('Access Denied: Only the librarian can delete class lists.', 'error');
        return;
      }
      if (confirm(`Are you sure you want to delete the class list "${listName}"?`)) {
        const savedLists = getData('savedClassLists');
        delete savedLists[listName];
        saveData('savedClassLists', savedLists);
        showNotification(`Class list "${listName}" deleted successfully.`, 'success');
        loadSavedClassListButtons();
        if (currentImportedLearners.length > 0 && !savedLists[listName]) {
          currentImportedLearners = [];
          classListTableBody.innerHTML = `<tr><td colspan="3">Class list cleared. Load another list or upload a new one.</td></tr>`;
        }
      }
    }

    function loadClassListWithBorrowedBooks(learnersToDisplay) {
      classListTableBody.innerHTML = '<tr><td colspan="3">Loading class list...</td></tr>';
      if (!learnersToDisplay || learnersToDisplay.length === 0) {
        classListTableBody.innerHTML = `<tr><td colspan="3">Upload an Excel file to see class list, or load a saved list.</td></tr>`;
        return;
      }
      learnersToDisplay.sort((a, b) => a.localeCompare(b));
      classListTableBody.innerHTML = '';
      learnersToDisplay.forEach(learnerName => {
        const tr = document.createElement('tr');
        tr.dataset.learnerName = learnerName.toLowerCase();
        const learnerCell = document.createElement('td');
        learnerCell.textContent = sanitizeInput(learnerName);
        tr.appendChild(learnerCell);
        const borrowedBooksCell = document.createElement('td');
        const statusCell = document.createElement('td');
        const learnerBorrowedBooks = cachedBorrowedBooks.filter(
          book => book.name.toLowerCase() === learnerName.toLowerCase() && book.status === 'Borrowed'
        );
        if (learnerBorrowedBooks.length > 0) {
          const ul = document.createElement('ul');
          ul.style.listStyle = 'none';
          ul.style.padding = '0';
          ul.style.margin = '0';
          let hasOverdue = false;
          const today = new Date().toISOString().split('T')[0];
          learnerBorrowedBooks.forEach(book => {
            const li = document.createElement('li');
            li.classList.add('borrowed-book-item');
            const isOverdue = today > book.returnDate;
            if (isOverdue) hasOverdue = true;
            li.innerHTML = `
              <span>
                <strong>${sanitizeInput(book.book)}</strong> (Due: ${book.returnDate})
                ${isOverdue ? '<span style="color:red; font-weight:bold;"> (OVERDUE)</span>' : ''}
              </span>
              ${isLibrarianMode ? `<button onclick="returnBook('${book.id}')">Returned</button>` : ''}
            `;
            ul.appendChild(li);
          });
          borrowedBooksCell.appendChild(ul);
          statusCell.textContent = hasOverdue ? 'Overdue Books' : 'Books Borrowed';
          statusCell.style.color = hasOverdue ? 'red' : 'green';
        } else {
          borrowedBooksCell.innerHTML = '<span class="no-books-borrowed">No books currently borrowed.</span>';
          statusCell.textContent = 'No Books Borrowed';
          statusCell.style.color = '#777';
        }
        tr.appendChild(borrowedBooksCell);
        tr.appendChild(statusCell);
        classListTableBody.appendChild(tr);
      });
    }

    // Export to Excel
    function exportToExcel() {
      if (typeof XLSX === 'undefined') {
        showNotification('Excel export library failed to load. Please check your internet connection or try again later.', 'error');
        console.error('SheetJS library not loaded.');
        return;
      }
      if (!cachedBorrowedBooks || cachedBorrowedBooks.length === 0) {
        showNotification('No borrowed books data to export.', 'error');
        return;
      }
      try {
        const ws = XLSX.utils.json_to_sheet(cachedBorrowedBooks);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Borrowed Books');
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'borrowed_books.xlsx';
        document.body.appendChild(a);
        a.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        setTimeout(() => showNotification('Borrowed books exported to Excel successfully.', 'success'), 500);
      } catch (e) {
        console.error('Export to Excel failed:', e);
        showNotification('Failed to export to Excel. Please try again.', 'error');
      }
    }

    // Table Sorting
    function sortTable(columnIndex, tableId) {
      const table = document.getElementById(tableId);
      const rows = Array.from(table.querySelector('tbody').rows);
      const isAscending = table.dataset.sortOrder !== 'asc';
      rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent;
        let bValue = b.cells[columnIndex].textContent;
        if (columnIndex === 6 || columnIndex === 7) { // Date columns
          aValue = new Date(aValue);
          bValue = new Date(bValue);
        }
        return isAscending ? aValue.localeCompare(bValue, undefined, { numeric: true }) : bValue.localeCompare(aValue, undefined, { numeric: true });
      });
      table.querySelector('tbody').innerHTML = '';
      rows.forEach(row => table.querySelector('tbody').appendChild(row));
      table.dataset.sortOrder = isAscending ? 'asc' : 'desc';
      const headers = table.querySelectorAll('th');
      headers.forEach((th, index) => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (index === columnIndex) {
          th.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    // Navigation
    function logout() {
      isLibrarianMode = false;
      libraryContent.style.display = 'none';
      loginScreen.style.display = 'flex';
      accessPasswordInput.value = '';
      loginButton.classList.remove('hidden');
      enterLibraryButton.classList.add('hidden');
      hideAllContentSections();
      initialButtonsDiv.classList.remove('hidden');
      navigationDiv.classList.add('hidden');
    }

    function showNavigation() {
      navigationDiv.classList.remove('hidden');
    }

    // Login Logic
    async function verifyMasterPassword(password) {
      // TODO: Replace with backend API call for secure authentication
      return password === MASTER_PASSWORD;
    }

    async function verifyLibrarianPassword(password) {
      // TODO: Replace with backend API call
      return password === LIBRARIAN_PASSWORD;
    }

    async function verifyBorrowPassword(password) {
      // TODO: Replace with backend API call
      return password === BORROW_PASSWORD;
    }

    // Wallpaper
    function loadSavedWallpaper() {
      const savedWallpaper = localStorage.getItem('savedWallpaper');
      if (savedWallpaper) {
        document.body.style.backgroundImage = `url('${savedWallpaper}')`;
        document.body.style.backgroundColor = 'transparent';
        wallpaperFileNameSpan.textContent = 'Previously chosen file';
      } else {
        document.body.style.backgroundImage = `url('https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Flag_of_Kenya.svg/1280px-Flag_of_Kenya.svg.png')`;
        wallpaperFileNameSpan.textContent = 'No file chosen';
      }
    }

    // Event Listeners
    loginButton.addEventListener('click', async () => {
      const password = accessPasswordInput.value;
      if (await verifyMasterPassword(password)) {
        loginErrorMessage.classList.add('hidden');
        loginButton.classList.add('hidden');
        enterLibraryButton.classList.remove('hidden');
      } else {
        loginErrorMessage.classList.remove('hidden');
        accessPasswordInput.value = '';
      }
    });

    enterLibraryButton.addEventListener('click', () => {
      loginScreen.style.display = 'none';
      libraryContent.style.display = 'block';
      hideAllContentSections();
      initialButtonsDiv.classList.remove('hidden');
    });

    accessPasswordInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') loginButton.click();
    });

    customWallpaperButton.addEventListener('click', () => {
      wallpaperInput.click();
    });

    wallpaperInput.addEventListener('change', event => {
      const file = event.target.files[0];
      if (file) {
        if (file.size > 2 * 1024 * 1024) { // Limit to 2MB
          showNotification('Image size must be less than 2MB.', 'error');
          wallpaperInput.value = '';
          return;
        }
        const reader = new FileReader();
        reader.onload = e => {
          const imageUrl = e.target.result;
          document.body.style.backgroundImage = `url('${imageUrl}')`;
          document.body.style.backgroundColor = 'transparent';
          localStorage.setItem('savedWallpaper', imageUrl);
          wallpaperFileNameSpan.textContent = file.name;
        };
        reader.readAsDataURL(file);
      } else {
        wallpaperFileNameSpan.textContent = 'No file chosen';
      }
    });

    librarianLoginBtn.addEventListener('click', async () => {
      const password = prompt('Enter librarian password:');
      if (await verifyLibrarianPassword(password)) {
        isLibrarianMode = true;
        initialButtonsDiv.classList.add('hidden');
        hideAllContentSections();
        notesSection.classList.remove('hidden');
        librarianToolsSection.classList.remove('hidden');
        borrowFormSection.classList.remove('hidden');
        borrowedLogSection.classList.remove('hidden');
        dueRemindersSection.classList.remove('hidden');
        learnerHistorySection.classList.remove('hidden');
        showNavigation();
        loadMembers();
        loadBookCatalog();
        loadBorrowed();
        loadDueReminders();
        loadSavedClassListButtons();
        loadClassListWithBorrowedBooks(currentImportedLearners);
        learnerSearchInput.value = '';
        borrowedSearchInput.value = '';
        loadLearnerHistory();
      } else {
        showNotification('Incorrect librarian password. Access denied.', 'error');
      }
    });

    borrowBookBtn.addEventListener('click', async () => {
      const password = prompt('Enter password to borrow a book:');
      if (await verifyBorrowPassword(password)) {
        isLibrarianMode = false;
        initialButtonsDiv.classList.add('hidden');
        hideAllContentSections();
        notesSection.classList.remove('hidden');
        borrowFormSection.classList.remove('hidden');
        borrowedLogSection.classList.remove('hidden');
        dueRemindersSection.classList.remove('hidden');
        showNavigation();
        loadBookCatalog();
        loadBorrowed();
        loadDueReminders();
        borrowedSearchInput.value = '';
      } else {
        showNotification('Incorrect borrow password. Access denied.', 'error');
      }
    });

    databaseBtn.addEventListener('click', async () => {
      const password = prompt('Enter librarian password to access Database:');
      if (await verifyLibrarianPassword(password)) {
        isLibrarianMode = false;
        initialButtonsDiv.classList.add('hidden');
        hideAllContentSections();
        borrowedLogSection.classList.remove('hidden');
        dueRemindersSection.classList.remove('hidden');
        learnerHistorySection.classList.remove('hidden');
        showNavigation();
        loadBorrowed();
        loadDueReminders();
        loadSavedClassListButtons();
        loadClassListWithBorrowedBooks(currentImportedLearners);
        learnerSearchInput.value = '';
        borrowedSearchInput.value = '';
        loadLearnerHistory();
      } else {
        showNotification('Incorrect database password. Access denied.', 'error');
      }
    });

    addMemberBtn.addEventListener('click', addMember);
    addBookToCatalogBtn.addEventListener('click', addBookToCatalog);
    borrowBookTitleSelect.addEventListener('change', updateBorrowBookType);
    nameInput.addEventListener('input', updateBorrowLimitInfo);
    borrowForm.addEventListener('submit', borrowBook);
    borrowedSearchInput.addEventListener('keyup', debounce(filterBorrowedBooks, 300));
    learnerSearchInput.addEventListener('keyup', debounce(loadLearnerHistory, 300));
    excelFileInput.addEventListener('change', e => importExcelFile(e.target.files[0]));
    resetExcelInputBtn.addEventListener('click', () => {
      excelFileInput.value = '';
      saveClassListDiv.classList.add('hidden');
      currentImportedLearners = [];
      classListTableBody.innerHTML = `<tr><td colspan="3">Upload an Excel file to see class list, or load a saved list.</td></tr>`;
    });
    saveClassListBtn.addEventListener('click', saveClassList);
    exportBorrowedBtn.addEventListener('click', exportToExcel);

    document.getElementById('backBtn').addEventListener('click', () => {
      hideAllContentSections();
      initialButtonsDiv.classList.remove('hidden');
      navigationDiv.classList.add('hidden');
    });

    document.getElementById('logoutBtn').addEventListener('click', logout);

    document.getElementById('borrowedBooksTable').querySelectorAll('th').forEach((th, index) => {
      if (index < 9) { // Exclude the Return button column
        th.addEventListener('click', () => sortTable(index, 'borrowedBooksTable'));
      }
    });

    // Initialize
    window.onload = () => {
      loginScreen.style.display = 'flex';
      libraryContent.style.display = 'none';
      initializeData();
      loadSavedWallpaper();
      loadClassListWithBorrowedBooks(currentImportedLearners);
      loadSavedClassListButtons();
    };
  </script>
</body>
</html>
